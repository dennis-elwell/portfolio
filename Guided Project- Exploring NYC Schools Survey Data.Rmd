---
title: 'Guided Project: Exploring NYC Schools Survey Data'
author: "Dennis Elwell"
date: "December 27, 2019"
output:
  html_document:
    df_print: paged
---

This is a guided project that I completed using the data science learning platform Dataquest.In this project, I will look at data from New York City schools to understand whether parent, teacher or student perceptions of the below factors affect average SAT scores:

1. Safety
2. Engagement
3. Communication
4. Academics

The data, collected in 2011, are publicly accessible and can be accessed [here](https://data.cityofnewyork.us/Education/2011-NYC-School-Survey/mnz3-dyi8).

To begin, I'll import the tidyverse

```{r}
library(tidyverse)
```


Next, I'll set my working directory and import the data
```{r}
setwd("C:/Users/Dennis/Desktop/nyc_schools_project")
sat <- read_csv("combined.csv")
gened <- read_tsv("masterfile11_gened_final.txt")
d75 <- read_tsv("masterfile11_d75_final.txt")
```

Now, let's preview our data for sat
```{r}
head(sat)
```

Then, let's take a look at our gened data

```{r}
head(gened)
```

Then, we'll look at our d75 data

```{r}
head(d75)
```


Let's trim our gened dataframe so that we're only looking at necessary variables
```{r}
gened_trimmed <- gened %>%
  select(dbn,bn, schoolname, d75,studentssurveyed,highschool,schooltype,saf_tot_11, com_tot_11, eng_tot_11, aca_tot_11) %>%
  rename(safety_respect_score = saf_tot_11, communication_score = com_tot_11, engagement_score = eng_tot_11,
         academic_expectations_score = aca_tot_11)

head(gened)
```

Let's do the same for our d75 dataframe

```{r}
d75_trimmed <- d75 %>%
  select(dbn,bn, schoolname, d75,studentssurveyed,highschool,schooltype,saf_tot_11, com_tot_11, eng_tot_11, aca_tot_11) %>%
  rename(safety_respect_score = saf_tot_11, communication_score = com_tot_11, engagement_score = eng_tot_11,
         academic_expectations_score = aca_tot_11)

head(d75)
```

Let's combine our d75 dataframe with our gened dataframe. We'll rename it survey

```{r}
survey <- d75_trimmed %>%
  rbind(gened_trimmed)

head(survey)
```

Now, let's join our survey dataframe with our sat dataframe. We'll call it master.

```{r}
master <- sat %>%
  inner_join(survey,by=c("DBN"="dbn")) %>%
  select(-schoolname,-bn) %>%
  mutate(avg_score = (safety_respect_score+communication_score+engagement_score+academic_expectations_score)/4)

head(master)
```



Let's create a function that let's us find the correlations between a variable and a list of other variables


```{r}
find_cor <- function(x,y,dat) {
  strength_corr <- function(z){
    if (z > 0.5){
      "Strong positive correlation"
    } else if (z < -0.5){
      "Strong negative correlation"
    } else {
      "Weak Correlation"
    }
  }
  cor_mat <- dat %>%
    select(x,y) %>%
    drop_na() %>%
    cor(method = "pearson") %>%
    round(2) %>% 
    .[,1, drop = FALSE] %>%
    as_tibble(rownames="variables") %>%
    rename(corrs = x) %>%
    arrange(desc(corrs)) %>%
    mutate(corr_strength = map_chr(corrs, strength_corr))
  return(cor_mat)
}

```


Let's find the correlation between avg_sat_score and each of the four survey scores. Let's see if there is any correlation between those scores and sat scores.

```{r}

find_cor("avg_sat_score",c("safety_respect_score","communication_score","engagement_score","academic_expectations_score"),master)

```

It looks like avg_sat_score most closely correlates with safety_respect_score (.28), followed in order by expectations_score (.18), engagement_score (.10) and communication_score (.09).

Let's repeat this process by seeing if avg_sat_score correlates with other variables.

```{r}
find_cor("avg_sat_score",c("frl_percent","ell_percent","sped_percent","asian_per","black_per","white_per","hispanic_per",
                           "male_per","female_per","grads_percent","dropout_percent"),master)
```


Let's create a list that contains all numeric column titles, and another variables which we decide determine "school quality"
```{r}
numeric_columns <- colnames(master[,map_lgl(master,is.numeric)])[1:25]

school_quality_columns <- c("SAT Writing Avg. Score","high_score_percent","dropout_percent","SAT Critical Reading Avg. Score",
                               "SAT Math Avg. Score","exams_per_student","avg_sat_score", "communication_score",
                               "engagement_score","grads_percent","academic_expectations_score","safety_respect_score")

```

Now let's iterate through our school quality columns and see each correlation dataframe.

```{r}
for (measure in school_quality_columns){
  print(find_cor(measure, numeric_columns,master))
}
```

```{r}
numeric_columns
```

Let's create a function that will visualize this.


```{r}
visualize_corrs <- function(corrs,title){
  ggplot(data = corrs) +
    aes( x = reorder(variables,corrs), y = corrs, fill = corr_strength) +
    scale_fill_manual(values = c("Strong positive correlation" ="blue", "Weak Correlation" = "gray",
                                 "Strong negative correlation" = "red")) +
    geom_bar(stat="identity", width = nrow(corrs)/(nrow(corrs)+5)) +
    theme(panel.background = element_blank()) +
    coord_flip() +
    labs(title= title, x="Variables", y = "Correlations") +
    theme(plot.title = element_text(hjust = -0.3, face = "bold"), axis.title.y = element_text(hjust=0.9, color = "gray"), 
          axis.title.x = element_text(hjust=0, color = "gray"), axis.text.x = element_text(color = "gray"),
          legend.position = "none") +
    geom_text(aes(label=corrs), hjust= -0.3)
}
```


Now, let's visualize our first set of data.


```{r}
avg_sat_score_corrs <- find_cor("avg_sat_score",c("safety_respect_score","communication_score",
                                                  "engagement_score","academic_expectations_score"),master)
visualize_corrs(corrs= avg_sat_score_corrs, title = "Correlations with Average SAT Score")

```

From this data, we can clearly see that safety respect score correlates most highly.

Let's try this with additional data.

```{r}
avg_sat_score_corrs_2 <- find_cor("avg_sat_score",c("frl_percent","ell_percent",
                                                    "sped_percent","asian_per","black_per","white_per",
                                                    "hispanic_per","male_per","female_per",
                                                    "grads_percent","dropout_percent"),master)

visualize_corrs(corrs = avg_sat_score_corrs_2, title = "Correlations with Average SAT Score")
```

Now that we have added additional variables, we can see that there are some variables that correlate very highly with average SAT score, and some of those have very strong negative correlations.


Now let's try this with additional variables.

```{r}
typeof(school_quality_columns)
```



```{r fig.height = 10, fig.width = 10}
for (measure in school_quality_columns){
  c <- find_cor(measure, numeric_columns,master)
  v <- visualize_corrs(corrs = c, title = paste("Correlations with", as.name(measure)))
  print(v)
}
```

From these bar charts, we can see that each of our success metrics has its own set of variables that have a strong positive correlation or a strong negative correlation. Let's filter out our weak correlations so that we only see strong correlations.


```{r fig.height = 5, fig.width = 10}
for (measure in school_quality_columns){
  c <- find_cor(measure, numeric_columns,master)
  c <- c %>%
    filter(corr_strength != "Weak Correlation")
  v <- visualize_corrs(corrs = c, title = paste("Correlations with", as.name(measure)))
  print(v)
}
```

Now we can more easily see the correlations that are most strongly affecting each of our success metrics. 

Now that we've seen these correlations, it would be interesting to see whether parents, students and teachers have similar perceptions about the four school quality metrics they were surveyed about:

  - Safety and Respect
  - Communication
  - Engagement
  - Academic Expectations
  
Let's go back to our dataset and see how these compare between parents, students and teachers.

```{r}
head(gened)


```


```{r}
gened_trimmed_2 <- gened %>%
  select(colnames(gened[1:32]))

d75_trimmed_2 <- d75 %>%
  select(colnames(d75[1:32]))

survey_2 <- gened_trimmed_2 %>%
  rbind(d75_trimmed_2)

head(survey_2)

```

Let's look at the size of our new data set

```{r}
print(paste("Number of rows:", nrow(survey_2)))
print(paste("Number of columns:", ncol(survey_2)))
```

Let's see how many rows we are left with once we drop all rows that have any NA values. The effect of this is likely to remove any non-high schools.

```{r}
survey_2 <- survey_2 %>%
  drop_na()

print(paste("Number of rows:", nrow(survey_2)))
print(paste("Number of columns:", ncol(survey_2)))
```

Now, we're left with a data set that is about one quarter of the original size. Since it's still a large dataset, let's keep it.


```{r}
survey_3 <- survey_2 %>%
  gather(key = "Survey Question", value = score, colnames(.[8:32])) %>%
  mutate(response_type = str_sub(`Survey Question`, start = regexpr("_[tsp]",`Survey Question`)+1,
                                                             end = (regexpr("_[tsp]",`Survey Question`))+1)) %>%
  filter(!`Survey Question` %in% c("aca_tot_11","com_tot_11","eng_tot_11","saf_tot_11")) %>%
  mutate(response_type = ifelse(response_type == "p", "parent",
                                ifelse(`response_type` == "s", "student", "teacher"))) %>%
  mutate(metric = str_sub(`Survey Question`, end = regexpr("_", `Survey Question`)-1)) %>%
  mutate(metric = ifelse(metric == "aca","academic expectations",
                         ifelse(metric == "com", "communication",
                                ifelse(metric == "eng", "engagement",
                                       ifelse(metric == "N", "number",
                                              ifelse(metric == "nr","number eligible",
                                                     ifelse(metric == "rr", "response rate", "safety")))))))

survey_3

```


```{r}
survey_3_rr_grouped <- survey_3 %>%
  filter(metric == "response rate") %>%
  group_by(response_type) %>%
  summarize(avg_score = round(mean(score),0)) %>%
  arrange(desc(avg_score)) %>%
  mutate(highest_score = ifelse(avg_score == max(avg_score),TRUE,FALSE), measure = "response rate") 

survey_3_rr_grouped

```


```{r fig.width = 8}

bar_chart_survey_3_rr_grouped <- ggplot(data = survey_3_rr_grouped) +
  aes(x = reorder(response_type, avg_score), y = avg_score, fill = highest_score) +
  scale_fill_manual(values = c("TRUE" = "blue", "FALSE" = "light gray"))+
  geom_bar(stat = "identity") +
  coord_flip() +
  labs(title = "Average Response Rates by Group", x = "Group", y = "Average Response Rate")+
  theme(panel.background = element_blank()) +
  geom_text(aes(label= paste0(avg_score,"%")),hjust = -0.1) +
  theme(plot.title = element_text(hjust = -0.1, face = "bold"), axis.title.y = element_text(hjust=0.9, vjust= 2, color = "gray"), 
          axis.title.x = element_text(hjust=0, color = "gray"), axis.text.x = element_text(color = "gray"),
          legend.position = "none") 
  
  

bar_chart_survey_3_rr_grouped

```


```{r}
survey_3_rr <- survey_3 %>%
  filter(metric == "response rate")

survey_3_rr
```



```{r}
boxplot_survey_3_rr <- ggplot(data = survey_3_rr) +
  aes(x = reorder(response_type,score, FUN = mean), y = score) +
  geom_boxplot() +
  coord_flip()+
  theme(panel.background = element_blank()) +
  labs(title = "Average Response Rates by Group", x = "Group", y = "Response Rate") +
  theme(plot.title = element_text(hjust = -0.1, face = "bold"), axis.title.y = element_text(hjust=0.9, vjust= 2, color = "gray"), 
          axis.title.x = element_text(hjust=0, color = "gray"), axis.text.x = element_text(color = "gray"),
          legend.position = "none")

boxplot_survey_3_rr

```

```{r}
make_boxplot <- function(dat, metric = dat$metric) {
  ggplot(data = dat) +
  aes(x = reorder(response_type,score, FUN = mean), y = score) +
  geom_boxplot() +
  coord_flip()+
  theme(panel.background = element_blank()) +
  labs(title = paste("Average", metric, "by group"), x = "group", y = metric) +
  theme(plot.title = element_text(hjust = -0.1, face = "bold"), axis.title.y = element_text(hjust=0.9, vjust= 2, color = "gray"), 
          axis.title.x = element_text(hjust=0, color = "gray"), axis.text.x = element_text(color = "gray"),
          legend.position = "none")
}
```

```{r}
make_boxplot(survey_3_rr)
```


```{r}
#for (metric in col)

metrics <- count(survey_3,metric)[1]
```

```{r}
make_boxplot_data <- function(dat, chosen_metric){
  dat %>%
    filter(metric == chosen_metric)
  
}
```


```{r}
make_boxplot_data(survey_3, "communication")
```

```{r}
metrics_2 <- unlist(metrics)

metrics_2

```


```{r}
make_boxplot(make_boxplot_data(survey_3,"communication"))
```



```{r}
for (m in unlist(metrics)){
  boxplot_data <- make_boxplot_data(survey_3,m)
  boxplot <- make_boxplot(boxplot_data)
  print(boxplot)
}
```

```{r}

make_bar_chart <- function(dat, measure = dat$measure){
  ggplot(data = dat) +
  aes(x = reorder(response_type, avg_score), y = avg_score, fill = highest_score) +
  scale_fill_manual(values = c("TRUE" = "blue", "FALSE" = "light gray"))+
  geom_bar(stat = "identity") +
  coord_flip() +
  labs(title = paste("Average", measure, "by group"), x = "group", y = measure)+
  theme(panel.background = element_blank()) +
  geom_text(aes(label= avg_score,hjust = -0.1)) +
  theme(plot.title = element_text(hjust = -0.1, face = "bold"), axis.title.y = element_text(hjust=0.9, vjust= 2, color = "gray"), 
          axis.title.x = element_text(hjust=0, color = "gray"), axis.text.x = element_text(color = "gray"),
          legend.position = "none") 
  
}

```


```{r}
make_bar_chart(survey_3_rr_grouped)
```


```{r}

make_bar_chart_data <- function(dat, chosen_measure){
  dat %>%
  filter(metric == chosen_measure) %>%
  group_by(response_type) %>%
  summarize(avg_score = round(mean(score),1)) %>%
  arrange(desc(avg_score)) %>%
  mutate(highest_score = ifelse(avg_score == max(avg_score),TRUE,FALSE), measure = chosen_measure)
}
  
  
```


```{r}

make_bar_chart(make_bar_chart_data(survey_3,"communication"))


```


```{r fig.width = 10}
for (m in unlist(metrics)){
  bar_chart_data <- make_bar_chart_data(survey_3,m)
  bar_chart <- make_bar_chart(bar_chart_data)
  print(bar_chart)
}
```


Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
